<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Video Recorder ‚Äî FPS / expozice / rozli≈°en√≠</title>
<meta name="theme-color" content="#0f172a" />
<style>
  :root{ --bg:#0b1220; --ui:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --accent:#22c55e; --red:#ef4444; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .app{display:grid;grid-template-columns:1fr;gap:16px;max-width:1100px;margin:0 auto;padding:16px}
  .panel{background:var(--ui);border-radius:16px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  h1{margin:0 0 6px;font-size:20px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  select,input,button{width:100%;background:#0c1a32;color:var(--text);border:1px solid #1f2a44;border-radius:10px;padding:10px 12px}
  input[type=range]{padding:0}
  .grid{display:grid;gap:10px}
  .g2{grid-template-columns:1fr 1fr}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
  .btn{cursor:pointer;border:none}
  .btn.primary{background:var(--accent)}
  .btn.danger{background:var(--red)}
  .hint{font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0c1a32;border:1px solid #1f2a44;border-radius:6px;padding:2px 6px}
  video{width:100%;max-height:60vh;background:#000;border-radius:14px}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  .pill{font-size:12px;color:var(--muted);background:#0c1a32;border:1px solid #1f2a44;padding:6px 8px;border-radius:999px}
  .right{justify-content:flex-end}
  .ok{color:#86efac}.warn{color:#fbbf24}.err{color:#f87171}
  .mono{font-family:ui-monospace,Consolas,monospace}
</style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <h1>üé• Nahr√°v√°n√≠ videa ‚Äî FPS / expozice / rozli≈°en√≠</h1>

      <div class="grid g2">
        <div>
          <label for="camera">Kamera</label>
          <select id="camera"></select>
        </div>

        <div>
          <label for="resolution">Rozli≈°en√≠ (≈°√≠≈ôka √ó v√Ω≈°ka)</label>
          <select id="resolution">
            <option value="3840x2160">3840 √ó 2160 (4K)</option>
            <option value="2560x1440">2560 √ó 1440 (QHD)</option>
            <option value="1920x1080" selected>1920 √ó 1080 (FHD)</option>
            <option value="1280x720">1280 √ó 720 (HD)</option>
            <option value="640x480">640 √ó 480 (VGA)</option>
            <option value="custom">Vlastn√≠‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="grid g2">
        <div>
          <label for="customRes" class="hint">Vlastn√≠ rozli≈°en√≠</label>
          <div class="grid g2" id="customRes" style="display:none">
            <div>
              <label for="w">≈†√≠≈ôka [px]</label>
              <input id="w" type="number" min="160" step="1" value="1920" />
            </div>
            <div>
              <label for="h">V√Ω≈°ka [px]</label>
              <input id="h" type="number" min="120" step="1" value="1080" />
            </div>
          </div>
        </div>

        <div>
          <label for="fpsSel">Sn√≠mkovac√≠ frekvence (FPS)</label>
          <select id="fpsSel">
            <option value="auto" selected>Auto</option>
          </select>
          <div class="hint" id="fpsHint">Mo≈ænosti se naƒçtou po spu≈°tƒõn√≠ n√°hledu z kamery.</div>
        </div>
      </div>

      <div class="grid g2">
        <div>
          <label for="exposure">D√©lka expozice <span id="expLabel" class="hint">(zji≈°≈•uji podporu‚Ä¶)</span></label>
          <input id="exposure" type="range" min="0" max="0" step="1" value="0" disabled />
          <div class="hint" id="expHint">Zobrazuje se jako fotografick√© ‚Äûƒçasy‚Äú (nap≈ô. 1/1000 s).</div>
        </div>
        <div style="align-self:end">
          <button id="apply" class="btn">‚úîÔ∏è Potvrdit nastaven√≠</button>
          <div class="hint">Po zmƒõnƒõ parametr≈Ø v≈ædy stiskni.</div>
        </div>
      </div>

      <div class="flex" style="margin-top:8px">
        <span class="pill">Stav: <span id="status" class="mono warn">ƒçek√°m‚Ä¶</span></span>
        <span class="pill">Aktivn√≠: <span id="live" class="mono">‚Äì</span></span>
        <span class="pill">Rozli≈°en√≠: <span id="curRes" class="mono">‚Äì</span></span>
        <span class="pill">FPS: <span id="curFps" class="mono">‚Äì</span></span>
        <span class="pill">Expozice: <span id="curExp" class="mono">‚Äì</span></span>
      </div>
    </div>

    <div class="panel">
      <video id="video" playsinline autoplay muted></video>
      <div class="row" style="margin-top:8px">
        <div class="flex">
          <button id="recStart" class="btn primary">‚è∫Ô∏è Zaƒç√≠t nahr√°vat</button>
          <button id="recStop" class="btn danger" disabled>‚èπÔ∏è Zastavit & ulo≈æit</button>
        </div>
        <div class="flex right">
          <span class="pill">D√©lka: <span id="timer" class="mono">00:00</span></span>
          <span class="pill">Velikost: <span id="size" class="mono">0 MB</span></span>
        </div>
      </div>
      <div id="downloads" class="flex" style="margin-top:8px;flex-wrap:wrap"></div>
    </div>
  </div>

<script>
(async function(){
  const els = {
    camera: document.getElementById('camera'),
    resolution: document.getElementById('resolution'),
    customRes: document.getElementById('customRes'),
    w: document.getElementById('w'),
    h: document.getElementById('h'),
    fpsSel: document.getElementById('fpsSel'),
    fpsHint: document.getElementById('fpsHint'),
    exposure: document.getElementById('exposure'),
    expLabel: document.getElementById('expLabel'),
    expHint: document.getElementById('expHint'),
    apply: document.getElementById('apply'),
    video: document.getElementById('video'),
    recStart: document.getElementById('recStart'),
    recStop: document.getElementById('recStop'),
    timer: document.getElementById('timer'),
    size: document.getElementById('size'),
    downloads: document.getElementById('downloads'),
    status: document.getElementById('status'),
    live: document.getElementById('live'),
    curRes: document.getElementById('curRes'),
    curFps: document.getElementById('curFps'),
    curExp: document.getElementById('curExp'),
    log: document.getElementById('log'),
  };

  let stream=null, videoTrack=null, recorder=null, chunks=[];
  let timerInt=null, sizeBytes=0, imageCapture=null;

  const isSecure = window.isSecureContext === true;
  const COMMON_FPS = [15, 24, 25, 30, 48, 50, 60, 90, 100, 120, 144, 200, 240, 300, 400, 480, 600, 720, 960, 1000];

  function log(msg){ els.log.textContent += `${msg}\n`; }
  function fmtSize(b){ return (b/1048576).toFixed(2)+' MB'; }
  function setStatus(text,cls='ok'){ els.status.textContent=text; els.status.className=`mono ${cls}`; }

  // --- Expozice: form√°tov√°n√≠ jako ‚Äû1/1000 s‚Äú nebo ‚Äû2,0 s‚Äú ---
  function shutterFromSeconds(sec){
    if(!isFinite(sec) || sec<=0) return '‚Äì';
    if(sec >= 1){
      return `${sec.toFixed(1).replace('.', ',')} s`;
    }
    const denom = Math.round(1/sec);
    return `1/${denom} s`;
  }

  // Rozhodnut√≠ jednotek expozice (nƒõkter√© implementace ud√°vaj√≠ ms)
  let exposureUnit = 's'; // 's' | 'ms'
  function toSec(v){ return exposureUnit==='ms' ? (v/1000) : v; }
  function fromSec(sec){ return exposureUnit==='ms' ? (sec*1000) : sec; }

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      const sel = els.camera.value;
      els.camera.innerHTML = '';
      cams.forEach((d,i)=>{
        const opt=document.createElement('option');
        opt.value=d.deviceId; opt.textContent=d.label||`Kamera ${i+1}`;
        els.camera.appendChild(opt);
      });
      if (cams.some(c=>c.deviceId===sel)) els.camera.value = sel;
    }catch(e){ log('enumerateDevices: '+e.message); }
  }

  function parseResolution(){
    const v = els.resolution.value;
    if(v==='custom'){ return { width:+els.w.value||1920, height:+els.h.value||1080 }; }
    const [w,h]=v.split('x').map(Number); return { width:w, height:h };
  }

  function stopStream(){
    try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); } }catch{}
    stream=null; videoTrack=null; imageCapture=null; els.video.srcObject=null;
  }

  function buildConstraints(){
    const {width,height}=parseResolution();
    const deviceId = els.camera.value ? { exact: els.camera.value } : undefined;
    const fpsVal = els.fpsSel.value;
    const frameRate = fpsVal==='auto' ? { ideal: 30 } : { exact: Number(fpsVal) };
    return { audio:false, video:{ deviceId, width:{ideal:width}, height:{ideal:height}, frameRate } };
  }

  async function startOrUpdate(){
    if(!isSecure){ setStatus('Bƒõ≈æ√≠ mimo HTTPS/localhost ‚Äî prohl√≠≈æeƒç blokuje kameru. Otev≈ôi p≈ôes HTTPS.','err'); return; }
    setStatus('Spou≈°t√≠m stream‚Ä¶','warn');
    stopStream();
    try{
      stream = await navigator.mediaDevices.getUserMedia(buildConstraints());
      els.video.srcObject = stream;
      videoTrack = stream.getVideoTracks()[0];
      try{ imageCapture = new ImageCapture(videoTrack); }catch{ imageCapture=null; }

      await populateFpsOptions();   // jen z capabilities
      await updateExposureCapabilities();

      await listCameras();
      updateLiveInfo();
      setStatus('N√°hled bƒõ≈æ√≠','ok');
    }catch(e){
      setStatus('Chyba: '+e.message,'err');
      log(`${e.name}: ${e.message}\n${e.stack||''}`);
      stopStream();
    }
  }

  function updateLiveInfo(){
    if(!videoTrack){ els.live.textContent='‚Äì'; return; }
    const s=videoTrack.getSettings();
    els.live.textContent = videoTrack.readyState==='live' ? 'ANO' : 'NE';
    els.curRes.textContent = (s.width&&s.height) ? `${s.width}√ó${s.height}` : '‚Äì';
    els.curFps.textContent = s.frameRate ? `${s.frameRate.toFixed(1)}` : '‚Äì';
  }

  async function populateFpsOptions(){
    // Napl≈à jen podle capabilities.range (≈æ√°dn√© testov√°n√≠)
    const prev = els.fpsSel.value;
    els.fpsSel.innerHTML = '<option value="auto">Auto</option>';

    let supported = [];
    try{
      const caps = videoTrack?.getCapabilities?.();
      if(caps?.frameRate && Number.isFinite(caps.frameRate.min) && Number.isFinite(caps.frameRate.max)){
        const {min,max} = caps.frameRate;
        // vyfiltruj standardn√≠ sn√≠mkov√© frekvence v rozmez√≠
        supported = COMMON_FPS.filter(f => f >= Math.ceil(min-0.5) && f <= Math.floor(max+0.5));
        // kdy≈æ kamera vrac√≠ t≈ôeba min=0, max=1000 a nic mezi, nech√°me aspo≈à bƒõ≈æn√© volby
        if(!supported.length){ supported = [24,25,30,50,60]; }
        els.fpsHint.textContent = `Rozsah kamery: ${min.toFixed(1)}‚Äì${max.toFixed(1)} fps`;
      }else{
        els.fpsHint.textContent = 'Detekce FPS nepodporov√°na ‚Äî k dispozici jen Auto.';
      }
    }catch(e){
      els.fpsHint.textContent = 'Detekce FPS selhala ‚Äî k dispozici jen Auto.';
      log('populateFpsOptions: '+e.message);
    }

    supported.forEach(f=>{
      const o=document.createElement('option'); o.value=String(f); o.textContent=String(f); els.fpsSel.appendChild(o);
    });

    // pokus o zachov√°n√≠ volby
    if (Array.from(els.fpsSel.options).some(o=>o.value===prev)) els.fpsSel.value=prev;
  }

  async function updateExposureCapabilities(){
    if(!videoTrack) return;
    // Zkus MediaTrackCapabilities nejd≈ô√≠v
    const caps = videoTrack.getCapabilities?.() || {};
    let expCap = caps.exposureTime;

    // Fallback: ImageCapture.getPhotoCapabilities()
    if(!expCap && window.ImageCapture && imageCapture?.getPhotoCapabilities){
      try{
        const pc = await imageCapture.getPhotoCapabilities();
        if(pc.exposureTime?.min !== undefined){
          expCap = { min: pc.exposureTime.min, max: pc.exposureTime.max, step: pc.exposureTime.step || 1 };
        }
      }catch(e){ log('getPhotoCapabilities: '+e.message); }
    }

    if(expCap){
      // Urƒçi jednotku (hrubƒõ): pokud maxima >> 5, ber ms
      exposureUnit = (expCap.max > 5) ? 'ms' : 's';

      els.exposure.disabled=false;
      els.exposure.min = expCap.min;
      els.exposure.max = expCap.max;
      els.exposure.step = expCap.step || 1;

      // Nastav popisek rozsahu ‚Äûfoto‚Äú stylem
      const minS = shutterFromSeconds(toSec(expCap.max)); // pozor: vƒõt≈°√≠ ƒç√≠slo = del≈°√≠ ƒças ‚Üí men≈°√≠ zlomek
      const maxS = shutterFromSeconds(toSec(expCap.min));
      els.expLabel.textContent = `(rozsah ${minS} ‚Ä¶ ${maxS})`;

      // zkus manu√°ln√≠ re≈æim
      try{ await videoTrack.applyConstraints({ advanced:[{ exposureMode:'manual' }] }); }catch{}

      const s = videoTrack.getSettings?.() || {};
      const cur = (s.exposureTime!==undefined) ? s.exposureTime : expCap.min;
      els.exposure.value = cur;
      els.curExp.textContent = shutterFromSeconds(toSec(cur));
    }else{
      els.exposure.disabled=true;
      els.expLabel.textContent='(expozice nen√≠ podporov√°na na t√©to kame≈ôe/prohl√≠≈æeƒçi)';
      els.curExp.textContent='‚Äì';
    }
  }

  async function applyExposure(){
    if(!videoTrack || els.exposure.disabled) return;
    const raw = parseFloat(els.exposure.value);
    try{
      await videoTrack.applyConstraints({ advanced:[{exposureMode:'manual', exposureTime: raw}] });
      els.curExp.textContent = shutterFromSeconds(toSec(raw));
      setStatus('Expozice nastavena','ok');
    }catch(e){
      setStatus('Expozici nelze nastavit: '+e.message,'err');
      log('applyExposure: '+e.message);
    }
  }

  // --- Nahr√°v√°n√≠ (bez volby form√°tu; zkus√≠me vp8, jinak default) ---
  function startTimer(){
    const start=Date.now(); sizeBytes=0;
    clearInterval(timerInt);
    timerInt=setInterval(()=>{
      const s=Math.floor((Date.now()-start)/1000);
      const mm=String(Math.floor(s/60)).padStart(2,'0');
      const ss=String(s%60).padStart(2,'0');
      els.timer.textContent=`${mm}:${ss}`;
      els.size.textContent=fmtSize(sizeBytes);
    },250);
  }
  function stopTimer(){ clearInterval(timerInt); }

  async function startRecording(){
    if(!stream) await startOrUpdate();
    if(!stream) return;

    let options={};
    const prefer = 'video/webm;codecs=vp8';
    if(MediaRecorder.isTypeSupported?.(prefer)) options.mimeType=prefer;

    try{ recorder=new MediaRecorder(stream,options); }
    catch{ recorder=new MediaRecorder(stream); }

    chunks=[];
    recorder.ondataavailable=e=>{ if(e.data?.size>0){ chunks.push(e.data); sizeBytes+=e.data.size; } };
    recorder.onstop=()=>{
      stopTimer();
      const blob=new Blob(chunks,{type:recorder.mimeType||'video/webm'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      const ts=new Date().toISOString().replace(/[:.]/g,'-');
      a.href=url; a.download=`zaznam-${ts}.webm`;
      a.textContent=`‚¨áÔ∏è Ulo≈æit z√°znam (${(blob.size/1048576).toFixed(2)} MB)`;
      a.className='btn';
      const wrap=document.createElement('div'); wrap.className='panel'; wrap.style.background='#0c1a32'; wrap.appendChild(a);
      els.downloads.prepend(wrap);
      setStatus('Z√°znam ulo≈æen','ok');
    };
    recorder.start(300);
    startTimer();
    els.recStart.disabled=true; els.recStop.disabled=false;
    setStatus('Nahr√°v√°m‚Ä¶','ok');
  }

  function stopRecording(){
    if(recorder && recorder.state!=='inactive'){ recorder.stop(); }
    els.recStart.disabled=false; els.recStop.disabled=true;
    setStatus('Zastaveno','ok');
  }

  // UI
  els.apply.addEventListener('click', startOrUpdate);
  els.resolution.addEventListener('change', ()=>{ els.customRes.style.display = els.resolution.value==='custom' ? 'grid' : 'none'; });
  els.fpsSel.addEventListener('change', ()=> setStatus('Zmƒõna FPS p≈ôipravena ‚Äî stiskni ‚ÄûPotvrdit nastaven√≠‚Äú.','warn'));
  els.exposure.addEventListener('input', applyExposure);
  els.recStart.addEventListener('click', startRecording);
  els.recStop.addEventListener('click', stopRecording);

  // Start ‚Äì jen p≈ô√≠prava UI
  if(!isSecure){ setStatus('Otev≈ôi p≈ôes HTTPS / localhost. Z ‚Äûcontent://‚Äú nebo ‚Äûfile://‚Äú kamera nepojede.','err'); }
  else { setStatus('Klepni na ‚ÄûPotvrdit nastaven√≠‚Äú a povol kameru.','warn'); }

  await listCameras();
  navigator.mediaDevices.addEventListener?.('devicechange', listCameras);
  setInterval(()=>{ if(videoTrack) updateLiveInfo(); }, 1000);
})();
</script>
</body>
</html>
