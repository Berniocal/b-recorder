<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Video Recorder ‚Äî FPS / expozice / rozli≈°en√≠</title>
<meta name="theme-color" content="#0f172a" />
<style>
  :root{ --bg:#0b1220; --ui:#0f172a; --muted:#94a3b8; --text:#e2e8f0; --accent:#22c55e; --red:#ef4444; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .app{display:grid;grid-template-columns:1fr;gap:16px;max-width:1100px;margin:0 auto;padding:16px}
  .panel{background:var(--ui);border-radius:16px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  h1{margin:0 0 6px;font-size:20px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  select,input,button{width:100%;background:#0c1a32;color:var(--text);border:1px solid #1f2a44;border-radius:10px;padding:10px 12px}
  input[type=range]{padding:0}
  .grid{display:grid;gap:10px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr 1fr 1fr}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
  .btn{cursor:pointer;border:none}
  .btn.primary{background:var(--accent)}
  .btn.danger{background:var(--red)}
  .hint{font-size:12px;color:var(--muted)}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0c1a32;border:1px solid #1f2a44;border-radius:6px;padding:2px 6px}
  video{width:100%;max-height:60vh;background:#000;border-radius:14px}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  .pill{font-size:12px;color:var(--muted);background:#0c1a32;border:1px solid #1f2a44;padding:6px 8px;border-radius:999px}
  .right{justify-content:flex-end}
  .ok{color:#86efac}.warn{color:#fbbf24}.err{color:#f87171}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .inline{display:flex;gap:8px;align-items:center}
  fieldset[disabled]{opacity:.6}
</style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <h1>üé• Nahr√°v√°n√≠ videa ‚Äî FPS / expozice / rozli≈°en√≠</h1>

      <div class="grid g2">
        <div>
          <label for="camera">Kamera</label>
          <select id="camera"></select>
        </div>
        <div>
          <label for="mime">Form√°t z√°znamu</label>
          <select id="mime">
            <option value="video/webm;codecs=vp9">webm; VP9</option>
            <option value="video/webm;codecs=vp8" selected>webm; VP8</option>
            <option value="video/webm;codecs=av1">webm; AV1</option>
            <option value="video/webm">webm (auto)</option>
          </select>
        </div>
      </div>

      <div class="grid g2">
        <div>
          <label for="resolution">Rozli≈°en√≠ (≈°√≠≈ôka √ó v√Ω≈°ka)</label>
          <select id="resolution">
            <option value="3840x2160">3840 √ó 2160 (4K)</option>
            <option value="2560x1440">2560 √ó 1440 (QHD)</option>
            <option value="1920x1080" selected>1920 √ó 1080 (FHD)</option>
            <option value="1280x720">1280 √ó 720 (HD)</option>
            <option value="640x480">640 √ó 480 (VGA)</option>
            <option value="custom">Vlastn√≠‚Ä¶</option>
          </select>
        </div>
        <div class="grid g2" id="customRes" style="display:none">
          <div>
            <label for="w">≈†√≠≈ôka [px]</label>
            <input id="w" type="number" min="160" step="1" value="1920" />
          </div>
          <div>
            <label for="h">V√Ω≈°ka [px]</label>
            <input id="h" type="number" min="120" step="1" value="1080" />
          </div>
        </div>
      </div>

      <div class="grid g3">
        <div>
          <label for="fpsSel">Sn√≠mkovac√≠ frekvence (FPS)</label>
          <select id="fpsSel">
            <option value="auto" selected>Auto (doporuƒçeno)</option>
          </select>
          <div class="hint" id="fpsHint">Mo≈ænosti se naƒçtou po spu≈°tƒõn√≠ n√°hledu podle schopnost√≠ kamery / testu.</div>
        </div>
        <div>
          <label for="fpsCustom">Vlastn√≠ FPS</label>
          <div class="inline">
            <input id="fpsCustom" type="number" min="1" max="1200" step="1" placeholder="nap≈ô. 1000" />
            <button id="testCustom" class="btn">Otestovat</button>
          </div>
          <div class="hint">Rychl√Ω test, zda kamera um√≠ p≈ôesn√© FPS v aktu√°ln√≠m re≈æimu.</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="inline">
            <input id="preferMaxFps" type="checkbox" />
            <label for="preferMaxFps" class="hint">Preferovat max FPS (sn√≠≈æit rozli≈°en√≠, vypnout manu√°ln√≠ expozici)</label>
          </div>
          <button id="findMax" class="btn" style="margin-top:8px">Naj√≠t maximum</button>
        </div>
      </div>

      <div class="grid g2" style="margin-top:6px">
        <div>
          <label for="exposure">D√©lka expozice <span id="expLabel" class="hint">(zji≈°≈•uji podporu‚Ä¶)</span></label>
          <input id="exposure" type="range" min="0" max="0" step="1" value="0" disabled />
          <div class="hint" id="expHint">Je-li podporov√°no, nastavuje manu√°ln√≠ ƒças z√°vƒõrky.</div>
        </div>
        <div style="align-self:end">
          <button id="apply" class="btn">‚ñ∂Ô∏è Spustit / Aktualizovat n√°hled</button>
          <div class="hint">Po zmƒõnƒõ parametr≈Ø v≈ædy stiskni.</div>
        </div>
      </div>

      <div class="flex" style="margin-top:8px">
        <span class="pill">Stav: <span id="status" class="mono warn">ƒçek√°m‚Ä¶</span></span>
        <span class="pill">Aktivn√≠: <span id="live" class="mono">‚Äì</span></span>
        <span class="pill">Rozli≈°en√≠: <span id="curRes" class="mono">‚Äì</span></span>
        <span class="pill">FPS: <span id="curFps" class="mono">‚Äì</span></span>
        <span class="pill">Expozice: <span id="curExp" class="mono">‚Äì</span></span>
      </div>
    </div>

    <div class="panel">
      <video id="video" playsinline autoplay muted></video>
      <div class="row" style="margin-top:8px">
        <div class="flex">
          <button id="recStart" class="btn primary">‚è∫Ô∏è Zaƒç√≠t nahr√°vat</button>
          <button id="recStop" class="btn danger" disabled>‚èπÔ∏è Zastavit & ulo≈æit</button>
        </div>
        <div class="flex right">
          <span class="pill">D√©lka: <span id="timer" class="mono">00:00</span></span>
          <span class="pill">Velikost: <span id="size" class="mono">0 MB</span></span>
        </div>
      </div>
      <div id="downloads" class="flex" style="margin-top:8px;flex-wrap:wrap"></div>
    </div>

    <div class="panel">
      <h1>N√°povƒõda & pozn√°mky</h1>
      <ul class="hint" style="margin:0 0 6px 16px">
        <li>Web API vysok√° FPS ƒçasto umo≈æn√≠ jen p≈ôi n√≠zk√©m rozli≈°en√≠ a auto-expozici. Pou≈æij ‚ÄûPreferovat max FPS‚Äú.</li>
        <li>V ‚ÄûFPS:‚Äú vid√≠≈° skuteƒçn√© ƒç√≠slo z <span class="kbd">getSettings()</span>, tj. co kamera opravdu pos√≠l√°.</li>
      </ul>
      <div id="log" class="mono hint" style="white-space:pre-wrap"></div>
    </div>
  </div>

<script>
(async function(){
  const els = {
    camera: document.getElementById('camera'),
    mime: document.getElementById('mime'),
    resolution: document.getElementById('resolution'),
    customRes: document.getElementById('customRes'),
    w: document.getElementById('w'),
    h: document.getElementById('h'),
    fpsSel: document.getElementById('fpsSel'),
    fpsHint: document.getElementById('fpsHint'),
    fpsCustom: document.getElementById('fpsCustom'),
    testCustom: document.getElementById('testCustom'),
    preferMaxFps: document.getElementById('preferMaxFps'),
    findMax: document.getElementById('findMax'),
    exposure: document.getElementById('exposure'),
    expLabel: document.getElementById('expLabel'),
    expHint: document.getElementById('expHint'),
    apply: document.getElementById('apply'),
    video: document.getElementById('video'),
    recStart: document.getElementById('recStart'),
    recStop: document.getElementById('recStop'),
    timer: document.getElementById('timer'),
    size: document.getElementById('size'),
    downloads: document.getElementById('downloads'),
    status: document.getElementById('status'),
    live: document.getElementById('live'),
    curRes: document.getElementById('curRes'),
    curFps: document.getElementById('curFps'),
    curExp: document.getElementById('curExp'),
    log: document.getElementById('log'),
  };

  let stream=null, videoTrack=null, recorder=null, chunks=[];
  let timerInt=null, sizeBytes=0, imageCapture=null;
  const isSecure = window.isSecureContext === true;

  // Roz≈°√≠≈ôen√Ω seznam kandid√°t≈Ø a≈æ do 1200 fps
  const FPS_CANDIDATES = [15, 24, 25, 30, 48, 50, 60, 90, 100, 120, 144, 200, 240, 300, 360, 400, 480, 600, 720, 800, 960, 1000, 1200];

  function log(msg){ els.log.textContent += `${msg}\n`; }
  function fmtMs(ms){ return `${(+ms).toFixed(1)} ms`; }
  function fmtSize(b){ return (b/1048576).toFixed(2)+' MB'; }
  function setStatus(text,cls='ok'){ els.status.textContent=text; els.status.className=`mono ${cls}`; }

  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      const sel = els.camera.value;
      els.camera.innerHTML = '';
      cams.forEach((d,i)=>{
        const opt = document.createElement('option');
        opt.value = d.deviceId;
        opt.textContent = d.label || `Kamera ${i+1}`;
        els.camera.appendChild(opt);
      });
      if (cams.some(c=>c.deviceId===sel)) els.camera.value = sel;
    }catch(e){ log('enumerateDevices: '+e.message); }
  }

  function parseResolution(){
    const v = els.resolution.value;
    if(v==='custom'){ return { width:+els.w.value||1920, height:+els.h.value||1080 }; }
    const [w,h]=v.split('x').map(Number); return { width:w, height:h };
  }

  function stopStream(){
    try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); } }catch{}
    stream=null; videoTrack=null; imageCapture=null;
    els.video.srcObject=null;
  }

  function buildConstraints(){
    const preferMax = els.preferMaxFps.checked;
    const {width,height} = preferMax ? {width:320,height:240} : parseResolution();
    const deviceId = els.camera.value ? { exact: els.camera.value } : undefined;

    let frameRate;
    if(els.fpsSel.value==='auto'){
      frameRate = preferMax ? { min: 120, ideal: 480, max: 1200 } : { ideal: 30 };
    }else{
      const f = Number(els.fpsSel.value);
      frameRate = preferMax ? { min: f, ideal: f, max: f } : { exact: f };
    }

    return {
      audio:false,
      video:{
        deviceId,
        width:{ ideal: width },
        height:{ ideal: height },
        frameRate
      }
    };
  }

  async function startOrUpdate(){
    if(!isSecure){ setStatus('Bƒõ≈æ√≠ mimo HTTPS/localhost ‚Äî prohl√≠≈æeƒç blokuje kameru. Otev≈ôi p≈ôes HTTPS.','err'); return; }
    if(recorder && recorder.state==='recording'){ setStatus('Zastav nahr√°v√°n√≠, pak mƒõ≈à FPS/kameru/rozli≈°en√≠.','warn'); return; }

    setStatus('Spou≈°t√≠m stream‚Ä¶','warn');
    stopStream();

    try{
      const constraints = buildConstraints();
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      els.video.srcObject = stream;
      videoTrack = stream.getVideoTracks()[0];
      try{ imageCapture = new ImageCapture(videoTrack); }catch{ imageCapture=null; }

      await populateFpsOptions();   // autodetekce FPS
      await updateCapabilities();

      await listCameras();
      updateLiveInfo();
      setStatus('N√°hled bƒõ≈æ√≠','ok');
    }catch(e){
      setStatus('Chyba: '+e.message,'err');
      log(`${e.name}: ${e.message}\n${e.stack||''}`);
      stopStream();
    }
  }

  function updateLiveInfo(){
    if(!videoTrack){ els.live.textContent='‚Äì'; return; }
    const s=videoTrack.getSettings();
    els.live.textContent = videoTrack.readyState==='live' ? 'ANO' : 'NE';
    els.curRes.textContent = (s.width&&s.height) ? `${s.width}√ó${s.height}` : '‚Äì';
    els.curFps.textContent = s.frameRate ? `${s.frameRate.toFixed(1)}` : '‚Äì';
  }

  async function populateFpsOptions(){
    let supported = [];
    // 1) Podle capabilities
    try{
      const caps = videoTrack?.getCapabilities?.();
      if(caps?.frameRate){
        const {min, max} = caps.frameRate;
        if(Number.isFinite(min) && Number.isFinite(max)){
          supported = FPS_CANDIDATES.filter(f => f >= Math.ceil(min-0.5) && f <= Math.floor(max+0.5));
          log(`FPS capabilities: min=${min}, max=${max} ‚Üí ${supported.join(', ')}`);
        }
      }
    }catch(e){ log('getCapabilities frameRate: '+e.message); }

    // 2) Fallback ‚Äì aktivn√≠ test kandid√°t≈Ø
    if(!supported.length && videoTrack?.applyConstraints){
      const orig = videoTrack.getSettings().frameRate;
      for(const f of FPS_CANDIDATES){
        try{
          await videoTrack.applyConstraints({ frameRate: { exact: f } });
          const s = videoTrack.getSettings();
          if (Math.abs((s.frameRate||0) - f) < 0.8) supported.push(f);
        }catch{}
      }
      // n√°vrat k p≈ôibli≈æn√©mu p≈Øvodn√≠mu fps
      try{ await videoTrack.applyConstraints({ frameRate: { ideal: orig||30 } }); }catch{}
      supported = Array.from(new Set(supported)).sort((a,b)=>a-b);
      log(`FPS test: ${supported.join(', ') || '(nic nenalezeno)'}`);
    }

    // 3) Naplnƒõn√≠ selectu
    const prev = els.fpsSel.value;
    els.fpsSel.innerHTML = '<option value="auto">Auto (doporuƒçeno)</option>';
    (supported.length ? supported : [24,25,30,50,60]).forEach(f=>{
      const o=document.createElement('option'); o.value=String(f); o.textContent=String(f); els.fpsSel.appendChild(o);
    });
    // udr≈æ volbu, jinak auto
    if (Array.from(els.fpsSel.options).some(o=>o.value===prev)) els.fpsSel.value = prev; else els.fpsSel.value = 'auto';

    els.fpsHint.textContent = supported.length ? 'Naƒçten√© mo≈ænosti z kamery/testu.' : 'Pou≈æ√≠v√°m v√Ωchoz√≠ sadu (detekce FPS nepodporov√°na).';
  }

  async function updateCapabilities(){
    if(!videoTrack) return;
    const caps = videoTrack.getCapabilities?.() || {};
    let expCap = caps.exposureTime;

    if(!expCap && window.ImageCapture && imageCapture?.getPhotoCapabilities){
      try{
        const pc = await imageCapture.getPhotoCapabilities();
        if(pc.exposureTime?.min !== undefined){
          expCap = { min: pc.exposureTime.min, max: pc.exposureTime.max, step: pc.exposureTime.step||1 };
        }
      }catch(e){ log('getPhotoCapabilities: '+e.message); }
    }

    if(expCap && !els.preferMaxFps.checked){ // p≈ôi ‚Äûmax FPS‚Äú ƒçasto nutn√© nechat auto expozici
      els.exposure.disabled=false;
      els.exposure.min=Math.max(0,expCap.min);
      els.exposure.max=expCap.max;
      els.exposure.step=expCap.step||1;
      els.expLabel.textContent=`(podporov√°no; rozsah ${expCap.min}‚Äì${expCap.max})`;
      try{ await videoTrack.applyConstraints({ advanced:[{ exposureMode:'manual' }] }); }catch{}
      const s=videoTrack.getSettings?.()||{};
      if(s.exposureTime){ els.exposure.value=s.exposureTime; els.curExp.textContent=fmtMs(s.exposureTime); }
      else { els.exposure.value=els.exposure.min; els.curExp.textContent='‚Äì'; }
    }else{
      els.exposure.disabled=true;
      els.expLabel.textContent= els.preferMaxFps.checked ? '(expozice: auto kv≈Øli max FPS)' : '(expozice nen√≠ podporov√°na na t√©to kame≈ôe/prohl√≠≈æeƒçi)';
      els.curExp.textContent='‚Äì';
    }
  }

  // --- Testy FPS ---
  async function testExactFps(f){
    if(!videoTrack?.applyConstraints) return false;
    try{
      await videoTrack.applyConstraints({ frameRate:{ exact: f } });
      const s = videoTrack.getSettings();
      return Math.abs((s.frameRate||0) - f) < 0.8;
    }catch{ return false; }
  }

  async function findMaxFps(){
    if(!videoTrack){ setStatus('Nejprve spus≈• n√°hled.', 'warn'); return; }
    setStatus('Hled√°m maximum FPS‚Ä¶','warn');
    // pokus shora dol≈Ø
    const descending = [...FPS_CANDIDATES].sort((a,b)=>b-a);
    for(const f of descending){
      if(await testExactFps(f)){
        setStatus(`Nalezeno maximum ‚âà ${f} fps (v tomto re≈æimu).`, 'ok');
        // p≈ôidej do nab√≠dky a vyber
        ensureFpsInSelect(f);
        els.fpsSel.value = String(f);
        updateLiveInfo();
        return;
      }
    }
    setStatus('Max FPS: nic z testovan√Ωch nepro≈°lo, ponech√°v√°m Auto.', 'warn');
    els.fpsSel.value='auto';
  }

  function ensureFpsInSelect(f){
    if(!Array.from(els.fpsSel.options).some(o=>+o.value===f)){
      const o=document.createElement('option'); o.value=String(f); o.textContent=String(f);
      els.fpsSel.appendChild(o);
    }
  }

  // nahr√°v√°n√≠
  function startTimer(){
    const start=Date.now(); sizeBytes=0;
    clearInterval(timerInt);
    timerInt=setInterval(()=>{
      const s=Math.floor((Date.now()-start)/1000);
      const mm=String(Math.floor(s/60)).padStart(2,'0');
      const ss=String(s%60).padStart(2,'0');
      els.timer.textContent=`${mm}:${ss}`;
      els.size.textContent=fmtSize(sizeBytes);
    },250);
  }
  function stopTimer(){ clearInterval(timerInt); }

  async function startRecording(){
    if(!stream) await startOrUpdate();
    if(!stream) return;

    let options={}; const mime=els.mime.value;
    if(MediaRecorder.isTypeSupported?.(mime)) options.mimeType=mime;
    try{ recorder=new MediaRecorder(stream,options); }
    catch{ recorder=new MediaRecorder(stream); }

    chunks=[];
    recorder.ondataavailable=e=>{ if(e.data?.size>0){ chunks.push(e.data); sizeBytes+=e.data.size; } };
    recorder.onstop=()=>{
      stopTimer();
      const blob=new Blob(chunks,{type:recorder.mimeType||'video/webm'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      const ts=new Date().toISOString().replace(/[:.]/g,'-');
      a.href=url; a.download=`zaznam-${ts}.webm`;
      a.textContent=`‚¨áÔ∏è Ulo≈æit z√°znam (${(blob.size/1048576).toFixed(2)} MB)`;
      a.className='btn';
      const wrap=document.createElement('div'); wrap.className='panel'; wrap.style.background='#0c1a32'; wrap.appendChild(a);
      els.downloads.prepend(wrap);
      setStatus('Z√°znam ulo≈æen','ok');
    };
    recorder.start(300);
    startTimer();
    els.recStart.disabled=true; els.recStop.disabled=false;
    setStatus('Nahr√°v√°m‚Ä¶','ok');
  }

  function stopRecording(){
    if(recorder && recorder.state!=='inactive'){ recorder.stop(); }
    els.recStart.disabled=false; els.recStop.disabled=true;
    setStatus('Zastaveno','ok');
  }

  // UI
  els.apply.addEventListener('click', startOrUpdate);
  els.resolution.addEventListener('change', ()=>{ els.customRes.style.display = els.resolution.value==='custom' ? 'grid' : 'none'; });
  els.fpsSel.addEventListener('change', ()=> setStatus('Zmƒõna FPS p≈ôipravena ‚Äî stiskni ‚ÄûSpustit / Aktualizovat n√°hled‚Äú.','warn'));
  els.testCustom.addEventListener('click', async ()=>{
    const f = Number(els.fpsCustom.value);
    if(!f) return;
    if(!videoTrack){ setStatus('Nejprve spus≈• n√°hled.','warn'); return; }
    setStatus(`Testuji ${f} fps‚Ä¶`,'warn');
    const ok = await testExactFps(f);
    if(ok){ ensureFpsInSelect(f); els.fpsSel.value=String(f); setStatus(`OK ‚Äî ${f} fps funguje v tomto re≈æimu.`, 'ok'); updateLiveInfo(); }
    else { setStatus(`Nepro≈°lo ‚Äî ${f} fps v tomto re≈æimu nedostupn√©. Zkus ‚ÄûPreferovat max FPS‚Äú.`, 'err'); }
  });
  els.findMax.addEventListener('click', findMaxFps);
  els.exposure.addEventListener('input', async ()=>{
    // p≈ôi ‚Äûprefer max‚Äú expozici neovl√°d√°me
    if(els.preferMaxFps.checked) return;
    await applyExposure();
  });
  els.recStart.addEventListener('click', startRecording);
  els.recStop.addEventListener('click', stopRecording);

  // Start ‚Äì jen p≈ô√≠prava UI
  if(!isSecure){ setStatus('Otev≈ôi p≈ôes HTTPS / localhost. Z ‚Äûcontent://‚Äú nebo ‚Äûfile://‚Äú kamera nepojede.','err'); }
  else { setStatus('Klepni na ‚ÄûSpustit / Aktualizovat n√°hled‚Äú a povol kameru.','warn'); }

  await listCameras();
  navigator.mediaDevices.addEventListener?.('devicechange', listCameras);
  setInterval(()=>{ if(videoTrack) updateLiveInfo(); }, 1000);
})();
</script>
</body>
</html>